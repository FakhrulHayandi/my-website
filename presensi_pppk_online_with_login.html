<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PRESENSI PPPK - Online dengan Login Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  :root{--bg:#f8fafc;--card:#fff;--muted:#6b7280;--accent:#0ea5a4}
  body{font-family:Inter,system-ui,Arial;background:var(--bg);margin:0;padding:18px;color:#0f172a}
  .container{max-width:980px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:18px;margin:0}
  .small{font-size:13px;color:var(--muted)}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px}
  label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
  input[type=text], select{padding:8px;border-radius:8px;border:1px solid #e6eef6;width:100%;box-sizing:border-box;margin-top:6px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:10px}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
  button.secondary{background:#64748b}
  button.danger{background:#ef4444}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6eef6;padding:8px;text-align:center;font-size:13px}
  th{background:#f1f5f9}
  .hidden{display:none}
  .login-box{max-width:360px;margin:30px auto;padding:18px;background:white;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .field{margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>PRESENSI PPPK</h1>
      <div class="small">Data tersimpan di browser (localStorage). Unduh file Excel untuk backup.</div>
    </div>
  </header>

  <div id="loginBox" class="card login-box">
    <h2 style="margin-top:0">Login Admin</h2>
    <div class="field"><input id="loginUser" type="text" placeholder="Username" /></div>
    <div class="field"><input id="loginPass" type="password" placeholder="Password" /></div>
    <div class="controls">
      <button id="btnLogin">Login</button>
    </div>
    <div class="small" style="margin-top:8px">Default admin: <strong>admin</strong> / <strong>1234</strong></div>
  </div>

  <div id="app" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Form Presensi</h2>
      <div>
        <button id="btnLogout" class="secondary">Logout</button>
      </div>
    </div>

    <label>Nama Pegawai</label>
    <input type="text" id="nama" placeholder="Masukkan nama">

    <label>NIP</label>
    <input type="text" id="nip" placeholder="Masukkan NIP">

    <label>Status Kehadiran</label>
    <select id="status">
      <option value="Hadir">Hadir</option>
      <option value="Izin">Izin</option>
      <option value="Sakit">Sakit</option>
      <option value="Dinas Luar">Dinas Luar</option>
    </select>

    <div class="controls">
      <button id="btnMasuk">Absen Masuk</button>
      <button id="btnPulang">Absen Pulang</button>
      <button id="btnRekap" class="secondary">Lihat Rekap Bulanan</button>
      <button id="btnReset" class="danger">Reset Semua Data</button>
      <button id="btnExport">Unduh Excel</button>
    </div>

    <h3>Absensi Harian</h3>
    <table id="tabelHarian">
      <thead>
        <tr><th>No</th><th>Nama</th><th>NIP</th><th>Tanggal</th><th>Jam Masuk</th><th>Jam Pulang</th><th>Keterangan</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="rekapSection" class="hidden">
      <h3>Rekap Bulanan</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label style="margin:0">Pilih Bulan</label>
        <input type="month" id="monthPicker" />
        <button id="btnFilter" class="secondary">Filter</button>
        <button id="btnExportRekap">Unduh Rekap Excel</button>
      </div>
      <table id="tabelRekap">
        <thead>
          <tr><th>No</th><th>Nama</th><th>NIP</th><th>Hadir</th><th>Izin</th><th>Sakit</th><th>Dinas Luar</th><th>Total Hari</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <footer class="small" style="margin-top:12px">File ini bisa dihosting untuk online access â€” cukup upload ke hosting (GitHub Pages, Netlify, dsb).</footer>
</div>

<script>
// Simple Presensi PPPK app with basic admin login
const ADMIN_USER = 'admin';
const ADMIN_PASS = '1234'; // default; change in file if needed
const STORAGE_KEY = 'presensi_pppk_v3';

let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

// Elements
const loginBox = document.getElementById('loginBox');
const app = document.getElementById('app');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const btnMasuk = document.getElementById('btnMasuk');
const btnPulang = document.getElementById('btnPulang');
const btnRekap = document.getElementById('btnRekap');
const btnReset = document.getElementById('btnReset');
const btnExport = document.getElementById('btnExport');
const btnExportRekap = document.getElementById('btnExportRekap');
const btnRekapSection = document.getElementById('rekapSection');
const monthPicker = document.getElementById('monthPicker');
const btnFilter = document.getElementById('btnFilter');
const btnExportRekapLocal = document.getElementById('btnExportRekap');

function nowISO(){ return new Date().toISOString().slice(0,10); }
function nowTime(){ return new Date().toLocaleTimeString('id-ID', {hour12:false}); }

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); renderTables(); }

function renderTables(){
  // harian
  const tbody = document.querySelector('#tabelHarian tbody');
  tbody.innerHTML = '';
  data.slice().sort((a,b)=> b.tanggal.localeCompare(a.tanggal) || a.nama.localeCompare(b.nama)).forEach((r,i)=>{
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${i+1}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.nip)}</td><td>${r.tanggal}</td><td>${r.jamMasuk}</td><td>${r.jamPulang}</td><td>${r.keterangan||'-'}</td><td>${r.status}</td>
    </tr>`);
  });
  // rekap if visible
  if(!btnRekapSection.classList.contains('hidden')) buildRekap();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

btnLogin.addEventListener('click', ()=>{
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if(u === ADMIN_USER && p === ADMIN_PASS){
    loginBox.classList.add('hidden');
    app.classList.remove('hidden');
    renderTables();
  } else {
    alert('Username atau password salah!');
  }
});

btnLogout.addEventListener('click', ()=>{
  if(confirm('Logout?')){
    app.classList.add('hidden');
    loginBox.classList.remove('hidden');
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
  }
});

btnMasuk.addEventListener('click', ()=>{
  const nama = document.getElementById('nama').value.trim();
  const nip = document.getElementById('nip').value.trim();
  const status = document.getElementById('status').value;
  if(!nama || !nip) return alert('Nama dan NIP wajib diisi!');
  const tgl = nowISO();
  // prevent duplicate per day per nip
  let rec = data.find(d=> d.nip===nip && d.tanggal===tgl);
  if(rec){
    if(rec.jamMasuk && rec.jamMasuk !== '-') {
      if(!confirm('Sudah ada absen masuk hari ini. Ganti waktu masuk?')) return;
    }
    rec.jamMasuk = nowTime();
    rec.status = status;
    rec.keterangan = status === 'Hadir' ? '-' : status;
  } else {
    data.push({nama, nip, tanggal: tgl, jamMasuk: nowTime(), jamPulang: '-', keterangan: status==='Hadir'?'-':status, status});
  }
  save();
});

btnPulang.addEventListener('click', ()=>{
  const nip = document.getElementById('nip').value.trim();
  if(!nip) return alert('Masukkan NIP!');
  const tgl = nowISO();
  let rec = data.find(d=> d.nip===nip && d.tanggal===tgl);
  if(!rec){
    if(!confirm('Belum ada absen masuk hari ini. Buat record pulang tanpa jam masuk?')) return;
    const nama = document.getElementById('nama').value.trim() || '-';
    data.push({nama, nip, tanggal: tgl, jamMasuk: '-', jamPulang: nowTime(), keterangan: 'Hanya Pulang', status: 'Hadir'});
  } else {
    rec.jamPulang = nowTime();
    if(!rec.keterangan || rec.keterangan === '-') rec.keterangan = 'Lengkap';
  }
  save();
});

btnRekap.addEventListener('click', ()=>{
  btnRekapSection.classList.toggle('hidden');
  if(!btnRekapSection.classList.contains('hidden')) buildRekap();
});

btnFilter.addEventListener('click', buildRekap);

function buildRekap(){
  const month = monthPicker.value; // yyyy-mm
  const map = {};
  data.forEach(a=>{
    if(month && !a.tanggal.startsWith(month)) return;
    const key = a.nip;
    if(!map[key]) map[key] = {nama: a.nama, nip: a.nip, Hadir:0, Izin:0, Sakit:0, 'Dinas Luar':0};
    if(a.status in map[key]) map[key][a.status] += 1;
  });
  const tbody = document.querySelector('#tabelRekap tbody');
  tbody.innerHTML = '';
  Object.values(map).forEach((r,i)=>{
    const total = r.Hadir + r.Izin + r.Sakit + r['Dinas Luar'];
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${i+1}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.nip)}</td><td>${r.Hadir}</td><td>${r.Izin}</td><td>${r.Sakit}</td><td>${r['Dinas Luar']}</td><td>${total}</td>
    </tr>`);
  });
}

// Reset
btnReset.addEventListener('click', ()=>{
  if(confirm('Hapus semua data absensi dari browser?')){
    data = [];
    localStorage.removeItem(STORAGE_KEY);
    renderTables();
  }
});

// Export XLSX - full harian
btnExport.addEventListener('click', ()=>{
  if(data.length === 0) return alert('Tidak ada data untuk diekspor.');
  const rows = data.map((d,i)=>({No: i+1, Nama: d.nama, NIP: d.nip, Tanggal: d.tanggal, 'Jam Masuk': d.jamMasuk, 'Jam Pulang': d.jamPulang, Keterangan: d.keterangan||'-', Status: d.status}));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Absensi');
  XLSX.writeFile(wb, 'Absensi_Harian.xlsx');
});

// Export Rekap filtered by month (or all)
btnExportRekapLocal.addEventListener('click', ()=>{
  const month = monthPicker.value;
  const map = {};
  data.forEach(a=>{
    if(month && !a.tanggal.startsWith(month)) return;
    if(!map[a.nip]) map[a.nip] = {Nama: a.nama, NIP: a.nip, Hadir:0, Izin:0, Sakit:0, 'Dinas Luar':0};
    if(a.status in map[a.nip]) map[a.nip][a.status] += 1;
  });
  const rows = Object.values(map).map((r, i)=>({No: i+1, Nama: r.Nama, NIP: r.NIP, Hadir: r.Hadir, Izin: r.Izin, Sakit: r.Sakit, 'Dinas Luar': r['Dinas Luar'], 'Total Hari': r.Hadir + r.Izin + r.Sakit + r['Dinas Luar']}));
  if(rows.length === 0) return alert('Tidak ada data rekap untuk diekspor.');
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Rekap');
  XLSX.writeFile(wb, `Rekap_${month || 'all'}.xlsx`);
});

// initial render if already logged in (optional)
renderTables();
</script>
</body>
</html>
